<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ë£¨ ì •ë¦¬ - InSight Stock AI</title>
    <link rel="stylesheet" href="style.css?v=7">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
</head>

<body class="dark-theme">
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <header>
        <nav>
            <div class="logo">
                <a href="index.html" style="text-decoration: none;">
                    <span class="gradient-text">InSight AI</span>
                </a>
            </div>
            <div class="nav-links">
                <button id="theme-toggle" class="icon-btn">
                    <span class="theme-icon">ğŸŒ™</span>
                </button>
            </div>
        </nav>
    </header>

    <main class="daily-summary-page">
        <!-- Page Title -->
        <section class="page-header">
            <h1 class="page-title">ğŸ“Š í•˜ë£¨ ì •ë¦¬</h1>
            <p class="page-date" id="summary-date">Loading...</p>
        </section>

        <!-- 1. ì‹œì¥ ê°œìš” -->
        <section class="summary-section" id="market-overview-section">
            <h2 class="section-title">ğŸ“ˆ ì‹œì¥ ê°œìš”</h2>

            <!-- ì§€ìˆ˜ ìˆ˜ìµë¥  í…Œì´ë¸” -->
            <div class="market-table-container">
                <table class="market-indices-table" id="indices-table">
                    <thead>
                        <tr>
                            <th>ì§€ìˆ˜</th>
                            <th>í˜„ì¬ê°€</th>
                            <th>ë³€ë™</th>
                            <th>ë³€ë™ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="indices-table-body">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>

            <!-- ì§€ìˆ˜ ì„ íƒ íƒ­ -->
            <div class="index-tabs" id="index-tabs">
                <button class="index-tab active" data-index="SP500">S&P 500</button>
                <button class="index-tab" data-index="NASDAQ">NASDAQ</button>
                <button class="index-tab" data-index="DOW">Dow Jones</button>
                <button class="index-tab" data-index="VIX">VIX</button>
                <button class="index-tab" data-index="RUSSELL2000">Russell 2000</button>
            </div>

            <!-- ì°¨íŠ¸ í•„í„° -->
            <div class="chart-filters" style="margin-bottom: 1rem;">
                <div class="filter-group range-filters">
                    <button class="filter-btn active" data-range="1m">1M</button>
                    <button class="filter-btn" data-range="3m">3M</button>
                    <button class="filter-btn" data-range="6m">6M</button>
                    <button class="filter-btn" data-range="1y">1Y</button>
                </div>
                <div class="filter-divider"></div>
                <div class="filter-group interval-filters">
                    <button class="filter-btn active" data-interval="d">ì¼ë´‰</button>
                    <button class="filter-btn" data-interval="w">ì£¼ë´‰</button>
                </div>
            </div>

            <!-- ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸ -->
            <div class="market-chart-container">
                <canvas id="market-index-chart"></canvas>
            </div>
        </section>

        <!-- 2. ì„¹í„°ë³„ ë™í–¥ -->
        <section class="summary-section" id="sectors-section">
            <h2 class="section-title">ğŸ¢ ì„¹í„°ë³„ ë™í–¥</h2>
            <div class="sector-chart-container">
                <canvas id="sector-chart"></canvas>
            </div>
            <div class="sectors-grid" id="sectors-grid">
                <!-- Dynamic content -->
            </div>
            <!-- ì„¹í„° ìƒì„¸ ë“œë¦´ë‹¤ìš´ -->
            <div class="sector-detail-container" id="sector-detail" style="display: none;">
                <div class="sector-detail-header">
                    <h3 id="sector-detail-title">Technology</h3>
                    <button class="sector-close-btn" onclick="closeSectorDetail()">âœ•</button>
                </div>
                <div class="sector-stocks-list" id="sector-stocks-list">
                    <!-- Dynamic content -->
                </div>
            </div>
        </section>

        <!-- 4. ê¸‰ë“±ë½ ê¸°ì—… -->
        <section class="summary-section" id="movers-section">
            <h2 class="section-title">ğŸš€ ê¸‰ë“±ë½ ê¸°ì—…</h2>
            <div class="movers-container">
                <div class="movers-column">
                    <h3 class="movers-title gainers">ğŸ“ˆ ìƒìŠ¹ TOP</h3>
                    <div class="movers-list" id="gainers-list">
                        <!-- Dynamic content -->
                    </div>
                </div>
                <div class="movers-column">
                    <h3 class="movers-title losers">ğŸ“‰ í•˜ë½ TOP</h3>
                    <div class="movers-list" id="losers-list">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. ì‹ ê³ ê°€ ê¸°ì—… -->
        <section class="summary-section" id="new-highs-section">
            <h2 class="section-title">ğŸ† 52ì£¼ ì‹ ê³ ê°€</h2>
            <p class="section-subtitle" id="new-highs-count">ì‹œê°€ì´ì•¡ $800M ì´ìƒ ê¸°ì—… ì¤‘ ì‹ ê³ ê°€ ë‹¬ì„±</p>
            <div class="new-highs-container" id="new-highs-container">
                <!-- Dynamic content -->
            </div>
        </section>
    </main>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('light-theme');
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            themeToggle.querySelector('.theme-icon').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
        });

        // State
        let sectorChart = null;
        let marketChart = null;
        let currentIndex = 'SP500';
        let currentRange = '1m';
        let currentInterval = 'd';
        let indicesData = {};

        // Display names
        const displayNames = {
            'SP500': 'S&P 500',
            'NASDAQ': 'NASDAQ',
            'DOW': 'Dow Jones',
            'VIX': 'VIX',
            'RUSSELL2000': 'Russell 2000',
            '10Y_TREASURY': '10Y Treasury'
        };

        // Load all data
        async function loadDailySummary() {
            const today = new Date();
            document.getElementById('summary-date').textContent =
                today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

            // Load all sections in parallel
            await Promise.all([
                loadMarketOverview(),
                loadSectors(),
                loadMovers(),
                loadNewHighs()
            ]);

            // Setup event listeners
            setupIndexTabs();
            setupChartFilters();
        }

        // 1. Market Overview - í…Œì´ë¸” + ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸
        async function loadMarketOverview() {
            const tableBody = document.getElementById('indices-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="loading">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const res = await fetch('/api/market-overview');
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                indicesData = data.indices;

                // Render table
                renderIndicesTable();

                // Render initial chart
                await loadIndexChart(currentIndex, currentRange, currentInterval);

            } catch (e) {
                console.error('Market overview error:', e);
                tableBody.innerHTML = '<tr><td colspan="4" class="error">ì‹œì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        function renderIndicesTable() {
            const tableBody = document.getElementById('indices-table-body');
            const order = ['SP500', 'NASDAQ', 'DOW', 'VIX', 'RUSSELL2000', '10Y_TREASURY'];

            let html = '';
            order.forEach(key => {
                const index = indicesData[key];
                if (!index) return;

                const isPositive = index.changePct >= 0;
                const changeClass = isPositive ? 'positive' : 'negative';
                const arrow = isPositive ? 'â–²' : 'â–¼';
                const sign = isPositive ? '+' : '';
                const priceDisplay = key === 'VIX' || key === '10Y_TREASURY'
                    ? index.price.toFixed(2)
                    : index.price.toLocaleString(undefined, { maximumFractionDigits: 2 });
                const changeDisplay = Math.abs(index.change).toFixed(2);

                html += `
                    <tr class="index-row ${key === currentIndex ? 'selected' : ''}" data-index="${key}">
                        <td class="index-name-cell">${displayNames[key]}</td>
                        <td class="index-price-cell">${priceDisplay}</td>
                        <td class="index-change-cell ${changeClass}">${arrow} ${changeDisplay}</td>
                        <td class="index-pct-cell ${changeClass}">${sign}${index.changePct.toFixed(2)}%</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;

            // Add click handlers to table rows
            document.querySelectorAll('.index-row').forEach(row => {
                row.addEventListener('click', () => {
                    const indexKey = row.dataset.index;
                    selectIndex(indexKey);
                });
            });
        }

        function selectIndex(indexKey) {
            currentIndex = indexKey;

            // Update table selection
            document.querySelectorAll('.index-row').forEach(row => {
                row.classList.toggle('selected', row.dataset.index === indexKey);
            });

            // Update tab selection
            document.querySelectorAll('.index-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.index === indexKey);
            });

            // Reload chart
            loadIndexChart(currentIndex, currentRange, currentInterval);
        }

        function setupIndexTabs() {
            document.querySelectorAll('.index-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const indexKey = tab.dataset.index;
                    selectIndex(indexKey);
                });
            });
        }

        function setupChartFilters() {
            const rangeBtns = document.querySelectorAll('#market-overview-section .range-filters .filter-btn');
            const intervalBtns = document.querySelectorAll('#market-overview-section .interval-filters .filter-btn');

            rangeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentRange = btn.dataset.range;
                    rangeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadIndexChart(currentIndex, currentRange, currentInterval);
                });
            });

            intervalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentInterval = btn.dataset.interval;
                    intervalBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadIndexChart(currentIndex, currentRange, currentInterval);
                });
            });
        }

        async function loadIndexChart(indexKey, range, interval) {
            const ctx = document.getElementById('market-index-chart');
            if (!ctx) return;

            try {
                // Get ticker symbol
                const tickerMap = {
                    'SP500': '^GSPC',
                    'NASDAQ': '^IXIC',
                    'DOW': '^DJI',
                    'VIX': '^VIX',
                    'RUSSELL2000': '^RUT',
                    '10Y_TREASURY': '^TNX'
                };

                const ticker = tickerMap[indexKey];
                const res = await fetch(`/api/historical?ticker=${ticker}&range=${range}&interval=${interval}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Prepare candlestick data
                const ohlcData = data.ohlc.map(d => ({
                    x: luxon.DateTime.fromISO(d.x).valueOf(),
                    o: parseFloat(d.o),
                    h: parseFloat(d.h),
                    l: parseFloat(d.l),
                    c: parseFloat(d.c)
                }));

                // Prepare volume data
                const volumeData = (data.volume || []).map(d => ({
                    x: luxon.DateTime.fromISO(d.x).valueOf(),
                    y: d.y
                }));

                // Prepare MA data
                const ma10Data = (data.ma10 || []).filter(d => d.y !== null).map(d => ({
                    x: luxon.DateTime.fromISO(d.x).valueOf(),
                    y: d.y
                }));
                const ma20Data = (data.ma20 || []).filter(d => d.y !== null).map(d => ({
                    x: luxon.DateTime.fromISO(d.x).valueOf(),
                    y: d.y
                }));

                renderMarketChart(ctx, ohlcData, volumeData, ma10Data, ma20Data, displayNames[indexKey]);

            } catch (e) {
                console.error('Chart load error:', e);
            }
        }

        function renderMarketChart(ctx, ohlcData, volumeData, ma10Data, ma20Data, title) {
            if (marketChart) marketChart.destroy();

            const isDark = body.classList.contains('dark-theme');
            const textColor = isDark ? '#94a3b8' : '#64748b';
            const gridColor = isDark ? '#334155' : '#e2e8f0';

            // ë‚ ì§œ ë ˆì´ë¸” ìƒì„± (ê±°ë˜ì¼ë§Œ)
            const labels = ohlcData.map(d => {
                const date = new Date(d.x);
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            });

            // OHLC ë°ì´í„°ë¥¼ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ë³€í™˜
            const ohlcIndexed = ohlcData.map((d, i) => ({
                x: i,
                o: d.o,
                h: d.h,
                l: d.l,
                c: d.c
            }));

            // ë³¼ë¥¨ ë°ì´í„°ë¥¼ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ë³€í™˜
            const volumeIndexed = volumeData.map((d, i) => ({
                x: i,
                y: d.y,
                color: i > 0 && ohlcData[i] && ohlcData[i - 1]
                    ? (ohlcData[i].c >= ohlcData[i - 1].c ? '#22c55e' : '#ef4444')
                    : '#94a3b8'
            }));

            // MA ë°ì´í„°ë¥¼ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ë³€í™˜
            const ma10Indexed = ma10Data.map((d, i) => ({ x: i, y: d.y }));
            const ma20Indexed = ma20Data.map((d, i) => ({ x: i, y: d.y }));

            // ë³¼ë¥¨ ìµœëŒ€ê°’ ê³„ì‚°
            const maxVolume = Math.max(...volumeIndexed.map(d => d.y || 0), 1);

            const datasets = [
                {
                    label: title,
                    data: ohlcIndexed,
                    type: 'candlestick',
                    color: {
                        up: '#22c55e',
                        down: '#ef4444',
                        unchanged: '#94a3b8'
                    },
                    borderColor: isDark ? '#ffffff33' : '#0000001a',
                    yAxisID: 'y',
                    barThickness: 8
                }
            ];

            // Add MAs
            if (ma10Indexed.length > 0) {
                datasets.push({
                    label: 'MA10',
                    type: 'line',
                    data: ma10Indexed,
                    borderColor: '#f59e0b',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y'
                });
            }
            if (ma20Indexed.length > 0) {
                datasets.push({
                    label: 'MA20',
                    type: 'line',
                    data: ma20Indexed,
                    borderColor: '#3b82f6',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y'
                });
            }

            // Add volume
            if (volumeIndexed.length > 0) {
                datasets.push({
                    label: 'ê±°ë˜ëŸ‰',
                    type: 'bar',
                    data: volumeIndexed.map(d => ({ x: d.x, y: d.y })),
                    backgroundColor: volumeIndexed.map(d => d.color + '60'),
                    borderColor: volumeIndexed.map(d => d.color),
                    borderWidth: 0,
                    yAxisID: 'volume',
                    barPercentage: 0.8,
                    categoryPercentage: 1
                });
            }

            marketChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    labels: labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: textColor,
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    if (items.length > 0) {
                                        return labels[items[0].dataIndex] || '';
                                    }
                                    return '';
                                },
                                label: (context) => {
                                    const d = context.raw;
                                    if (context.dataset.type === 'candlestick') {
                                        return [
                                            `ì‹œê°€: ${d.o?.toLocaleString() || '-'}`,
                                            `ê³ ê°€: ${d.h?.toLocaleString() || '-'}`,
                                            `ì €ê°€: ${d.l?.toLocaleString() || '-'}`,
                                            `ì¢…ê°€: ${d.c?.toLocaleString() || '-'}`
                                        ];
                                    }
                                    if (context.dataset.label === 'ê±°ë˜ëŸ‰') {
                                        const val = d.y || d;
                                        if (val >= 1e9) return `ê±°ë˜ëŸ‰: ${(val / 1e9).toFixed(2)}B`;
                                        if (val >= 1e6) return `ê±°ë˜ëŸ‰: ${(val / 1e6).toFixed(2)}M`;
                                        if (val >= 1e3) return `ê±°ë˜ëŸ‰: ${(val / 1e3).toFixed(2)}K`;
                                        return `ê±°ë˜ëŸ‰: ${val.toLocaleString()}`;
                                    }
                                    return `${context.dataset.label}: ${(d.y || d)?.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            grid: { color: gridColor, display: false },
                            ticks: {
                                color: textColor,
                                maxTicksLimit: 8,
                                maxRotation: 0,
                                autoSkip: true
                            }
                        },
                        y: {
                            position: 'right',
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: function (value) {
                                    if (value >= 1000) return value.toLocaleString();
                                    return value;
                                }
                            }
                        },
                        volume: {
                            position: 'left',
                            grid: { display: false },
                            ticks: { display: false },
                            min: 0,
                            max: maxVolume * 5,
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 2. Sectors
        async function loadSectors() {
            const grid = document.getElementById('sectors-grid');
            grid.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const res = await fetch('/api/sectors');
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                renderSectorChart(data.sectors);

                let html = '';
                data.sectors.forEach(sector => {
                    const isPositive = sector.dailyChange >= 0;
                    const changeClass = isPositive ? 'positive' : 'negative';
                    const arrow = isPositive ? 'â–²' : 'â–¼';

                    html += `
                        <div class="sector-card ${changeClass}" onclick="showSectorDetail('${sector.sector}')">
                            <span class="sector-name">${sector.sector}</span>
                            <span class="sector-etf">${sector.etf}</span>
                            <span class="sector-change ${changeClass}">${arrow} ${Math.abs(sector.dailyChange).toFixed(2)}%</span>
                            <span class="sector-expand-hint">í´ë¦­í•˜ì—¬ ì¢…ëª© ë³´ê¸° â†’</span>
                        </div>
                    `;
                });

                grid.innerHTML = html;

            } catch (e) {
                console.error('Sectors error:', e);
                grid.innerHTML = '<div class="error">ì„¹í„° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // Sector Detail Drill-down
        async function showSectorDetail(sectorName) {
            const container = document.getElementById('sector-detail');
            const title = document.getElementById('sector-detail-title');
            const list = document.getElementById('sector-stocks-list');

            title.textContent = `ğŸ“Š ${sectorName} ì„¹í„° ì¢…ëª©`;
            list.innerHTML = '<div class="loading">ì¢…ëª© ë°ì´í„° ë¡œë”© ì¤‘...</div>';
            container.style.display = 'block';

            try {
                const res = await fetch(`/api/sector-stocks?sector=${encodeURIComponent(sectorName)}`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                let html = '<table class="sector-stocks-table"><thead><tr><th>í‹°ì»¤</th><th>ì¢…ëª©ëª…</th><th>í˜„ì¬ê°€</th><th>ì¼ê°„</th><th>1ì£¼</th><th>1ê°œì›”</th><th>1ë…„</th></tr></thead><tbody>';

                data.stocks.forEach(stock => {
                    const dailyClass = stock.changePct >= 0 ? 'positive' : 'negative';
                    const weekClass = stock.week >= 0 ? 'positive' : 'negative';
                    const monthClass = stock.month >= 0 ? 'positive' : 'negative';
                    const yearClass = stock.year >= 0 ? 'positive' : 'negative';

                    const formatPct = (val, cls) => {
                        const sign = val >= 0 ? '+' : '';
                        return `<span class="${cls}">${sign}${val.toFixed(1)}%</span>`;
                    };

                    html += `
                        <tr class="stock-row" onclick="window.location.href='index.html?ticker=${stock.ticker}'">
                            <td class="stock-ticker">${stock.ticker}</td>
                            <td class="stock-name">${stock.name}</td>
                            <td class="stock-price">$${stock.price.toFixed(2)}</td>
                            <td class="stock-pct">${formatPct(stock.changePct, dailyClass)}</td>
                            <td class="stock-pct">${formatPct(stock.week, weekClass)}</td>
                            <td class="stock-pct">${formatPct(stock.month, monthClass)}</td>
                            <td class="stock-pct">${formatPct(stock.year, yearClass)}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                list.innerHTML = html;

            } catch (e) {
                console.error('Sector stocks error:', e);
                list.innerHTML = '<div class="error">ì¢…ëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function closeSectorDetail() {
            document.getElementById('sector-detail').style.display = 'none';
        }

        function renderSectorChart(sectors) {
            const ctx = document.getElementById('sector-chart');
            if (!ctx) return;

            if (sectorChart) sectorChart.destroy();

            const isDark = body.classList.contains('dark-theme');
            const textColor = isDark ? '#94a3b8' : '#64748b';

            sectorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sectors.map(s => s.sector),
                    datasets: [{
                        label: 'ì¼ê°„ ë³€ë™ë¥  (%)',
                        data: sectors.map(s => s.dailyChange),
                        backgroundColor: sectors.map(s => s.dailyChange >= 0 ? '#22c55e' : '#ef4444'),
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: isDark ? '#334155' : '#e2e8f0' },
                            ticks: { color: textColor }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: textColor, font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // 3. Movers
        async function loadMovers() {
            const gainersList = document.getElementById('gainers-list');
            const losersList = document.getElementById('losers-list');
            gainersList.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
            losersList.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const res = await fetch('/api/movers');
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                gainersList.innerHTML = data.gainers.map(stock => `
                    <div class="mover-item" onclick="window.location.href='index.html?ticker=${stock.ticker}'">
                        <div class="mover-info">
                            <span class="mover-ticker">${stock.ticker}</span>
                            <span class="mover-name">${stock.name}</span>
                        </div>
                        <div class="mover-change positive">+${stock.changePct.toFixed(2)}%</div>
                    </div>
                `).join('') || '<div class="no-data">ìƒìŠ¹ ì¢…ëª© ì—†ìŒ</div>';

                losersList.innerHTML = data.losers.map(stock => `
                    <div class="mover-item" onclick="window.location.href='index.html?ticker=${stock.ticker}'">
                        <div class="mover-info">
                            <span class="mover-ticker">${stock.ticker}</span>
                            <span class="mover-name">${stock.name}</span>
                        </div>
                        <div class="mover-change negative">${stock.changePct.toFixed(2)}%</div>
                    </div>
                `).join('') || '<div class="no-data">í•˜ë½ ì¢…ëª© ì—†ìŒ</div>';

            } catch (e) {
                console.error('Movers error:', e);
                gainersList.innerHTML = '<div class="error">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>';
                losersList.innerHTML = '<div class="error">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>';
            }
        }

        // 4. New Highs
        async function loadNewHighs() {
            const container = document.getElementById('new-highs-container');
            const countEl = document.getElementById('new-highs-count');
            container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const res = await fetch('/api/new-highs');
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                countEl.textContent = `ì‹œê°€ì´ì•¡ $800M ì´ìƒ ê¸°ì—… ì¤‘ ${data.totalCount}ê°œ ì¢…ëª© ì‹ ê³ ê°€ ë‹¬ì„±`;

                if (data.totalCount === 0) {
                    container.innerHTML = '<div class="no-data">ì˜¤ëŠ˜ ì‹ ê³ ê°€ ë‹¬ì„± ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                let html = '';
                Object.entries(data.bySector).forEach(([sector, stocks]) => {
                    html += `
                        <div class="new-high-sector">
                            <h4 class="sector-label">${sector} (${stocks.length})</h4>
                            <div class="new-high-stocks">
                                ${stocks.map(stock => `
                                    <div class="new-high-item" onclick="window.location.href='index.html?ticker=${stock.ticker}'">
                                        <span class="nh-ticker">${stock.ticker}</span>
                                        <span class="nh-name">${stock.name}</span>
                                        <span class="nh-price">$${stock.price.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (e) {
                console.error('New highs error:', e);
                container.innerHTML = '<div class="error">ì‹ ê³ ê°€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // 5. Market News

        // Initialize
        document.addEventListener('DOMContentLoaded', loadDailySummary);
    </script>
</body>

</html>