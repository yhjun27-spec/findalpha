<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°€ ìƒì„¸ ë¶„ì„ - InSight AI</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="main.js?v=11" defer></script>
</head>

<body class="dark-theme">
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <header>
        <nav>
            <div class="logo">
                <a href="index.html" class="ir-link"
                    style="font-size: 1.5rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">InSight
                    AI</a>
            </div>
            <button onclick="window.location.href='index.html'" class="icon-btn">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
        </nav>
    </header>

    <main class="dashboard-section">
        <div class="chart-container card" style="height: 85vh; display: flex; flex-direction: column;">
            <div class="chart-header">
                <h1 id="detail-ticker-title" class="ticker-name" style="font-size: 1.8rem;">ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</h1>
                <div class="chart-filters">
                    <div class="filter-group range-filters">
                        <button class="filter-btn" data-range="1m">1M</button>
                        <button class="filter-btn" data-range="3m">3M</button>
                        <button class="filter-btn" data-range="6m">6M</button>
                        <button class="filter-btn active" data-range="1y">1Y</button>
                        <button class="filter-btn" data-range="5y">5Y</button>
                        <button class="filter-btn" data-range="max">Max</button>
                    </div>
                    <div class="filter-divider"></div>
                    <div class="filter-group interval-filters">
                        <button class="filter-btn active" data-interval="d">ì¼ë´‰</button>
                        <button class="filter-btn" data-interval="w">ì£¼ë´‰</button>
                        <button class="filter-btn" data-interval="m">ì›”ë´‰</button>
                    </div>
                    <div class="filter-divider"></div>
                    <div class="filter-group drawing-tools">
                        <button id="btn-draw-line" class="filter-btn"
                            style="display: flex; align-items: center; gap: 0.3rem;">
                            âœï¸ ì§ì„ 
                        </button>
                        <button id="btn-clear-lines" class="filter-btn"
                            style="display: flex; align-items: center; gap: 0.3rem;">
                            ğŸ—‘ï¸ ì§€ìš°ê¸°
                        </button>
                    </div>
                </div>
            </div>
            <div class="chart-wrapper" style="flex: 1; min-height: 0; position: relative;">
                <canvas id="stock-chart"></canvas>
                <canvas id="drawing-overlay"
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>ì°¨íŠ¸ ìƒì„¸ ë¶„ì„ (AI)</h3>
            <p id="chart-ai-analysis">í¬ë§· êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ìƒì„¸ ë¶„ì„ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
        </div>

        <!-- Trade Recording Section -->
        <div class="card" id="trade-section">
            <h3>ğŸ“Š ë§¤ë§¤ ê¸°ë¡</h3>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 120px;">
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">ìˆ˜ëŸ‰</label>
                    <input type="number" id="trade-quantity" placeholder="ìˆ˜ëŸ‰" min="1" value="1"
                        style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main);">
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">ê°€ê²©
                        ($)</label>
                    <input type="number" id="trade-price" placeholder="ê°€ê²©" step="0.01"
                        style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main);">
                </div>
                <div style="flex: 1; min-width: 140px;">
                    <label
                        style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">ë‚ ì§œ</label>
                    <input type="date" id="trade-date"
                        style="width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-main);">
                </div>
                <button id="btn-buy" class="filter-btn"
                    style="background: #22c55e; color: white; padding: 0.6rem 1.5rem; font-weight: 600;">
                    ğŸ“ˆ ë§¤ìˆ˜
                </button>
                <button id="btn-sell" class="filter-btn"
                    style="background: #ef4444; color: white; padding: 0.6rem 1.5rem; font-weight: 600;">
                    ğŸ“‰ ë§¤ë„
                </button>
            </div>

            <div id="trade-history" style="margin-top: 1rem;">
                <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">ê±°ë˜ ë‚´ì—­</h4>
                <div id="trade-list" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: var(--text-muted); font-size: 0.85rem;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // detail page specialized logic
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const ticker = urlParams.get('ticker');
            if (ticker) {
                document.getElementById('detail-ticker-title').innerText = ticker + ' ì£¼ê°€ ì°¨íŠ¸ ìƒì„¸';
            }

            // Trade Recording Logic
            const TRADES_KEY = 'insight_trades';

            // Set default date to today
            const tradeDateInput = document.getElementById('trade-date');
            if (tradeDateInput) {
                tradeDateInput.value = new Date().toISOString().split('T')[0];
            }

            // Load trades from localStorage
            function getTrades() {
                const data = localStorage.getItem(TRADES_KEY);
                return data ? JSON.parse(data) : {};
            }

            // Save trades to localStorage
            function saveTrades(trades) {
                localStorage.setItem(TRADES_KEY, JSON.stringify(trades));
            }

            // Add a new trade
            function addTrade(type) {
                if (!ticker) return alert('í‹°ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.');

                const quantity = parseFloat(document.getElementById('trade-quantity').value);
                const price = parseFloat(document.getElementById('trade-price').value);
                const date = document.getElementById('trade-date').value;

                if (!quantity || quantity <= 0) return alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
                if (!price || price <= 0) return alert('ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                if (!date) return alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.');

                const trades = getTrades();
                if (!trades[ticker]) trades[ticker] = [];

                trades[ticker].push({
                    type: type,
                    quantity: quantity,
                    price: price,
                    date: date,
                    timestamp: Date.now()
                });

                saveTrades(trades);
                renderTradeHistory();

                // Trigger chart refresh to show new trade marker
                window.dispatchEvent(new CustomEvent('tradeAdded', { detail: { ticker, type, price, date } }));

                // Reset form
                document.getElementById('trade-quantity').value = 1;
                document.getElementById('trade-price').value = '';
            }

            // Render trade history
            function renderTradeHistory() {
                const trades = getTrades();
                const tickerTrades = trades[ticker] || [];
                const tradeList = document.getElementById('trade-list');

                if (tickerTrades.length === 0) {
                    tradeList.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // Sort by date (newest first)
                const sorted = [...tickerTrades].sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calculate summary
                let totalBuyQty = 0, totalBuyCost = 0, totalSellQty = 0, totalSellRevenue = 0;
                sorted.forEach(t => {
                    if (t.type === 'buy') {
                        totalBuyQty += t.quantity;
                        totalBuyCost += t.quantity * t.price;
                    } else {
                        totalSellQty += t.quantity;
                        totalSellRevenue += t.quantity * t.price;
                    }
                });
                const avgBuyPrice = totalBuyQty > 0 ? (totalBuyCost / totalBuyQty).toFixed(2) : '-';
                const holdingQty = totalBuyQty - totalSellQty;

                let html = `
                    <div style="background: rgba(255,255,255,0.03); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                            <span>ë³´ìœ  ìˆ˜ëŸ‰: <b>${holdingQty}</b></span>
                            <span>í‰ê·  ë§¤ìˆ˜ê°€: <b>$${avgBuyPrice}</b></span>
                            <span>ì´ íˆ¬ì: <b>$${totalBuyCost.toFixed(2)}</b></span>
                        </div>
                    </div>
                    <table style="width: 100%; font-size: 0.85rem; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 0.5rem;">ë‚ ì§œ</th>
                                <th style="text-align: center; padding: 0.5rem;">êµ¬ë¶„</th>
                                <th style="text-align: right; padding: 0.5rem;">ìˆ˜ëŸ‰</th>
                                <th style="text-align: right; padding: 0.5rem;">ê°€ê²©</th>
                                <th style="text-align: right; padding: 0.5rem;">ê¸ˆì•¡</th>
                                <th style="text-align: center; padding: 0.5rem;"></th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sorted.forEach((t, idx) => {
                    const isBuy = t.type === 'buy';
                    const color = isBuy ? '#22c55e' : '#ef4444';
                    const label = isBuy ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
                    const total = (t.quantity * t.price).toFixed(2);
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.5rem;">${t.date}</td>
                            <td style="text-align: center; padding: 0.5rem; color: ${color}; font-weight: 600;">${label}</td>
                            <td style="text-align: right; padding: 0.5rem;">${t.quantity}</td>
                            <td style="text-align: right; padding: 0.5rem;">$${t.price.toFixed(2)}</td>
                            <td style="text-align: right; padding: 0.5rem;">$${total}</td>
                            <td style="text-align: center; padding: 0.5rem;">
                                <button onclick="deleteTrade(${t.timestamp})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.8rem;">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                tradeList.innerHTML = html;
            }

            // Delete a trade
            window.deleteTrade = function (timestamp) {
                if (!confirm('ì´ ê±°ë˜ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
                const trades = getTrades();
                if (trades[ticker]) {
                    trades[ticker] = trades[ticker].filter(t => t.timestamp !== timestamp);
                    saveTrades(trades);
                    renderTradeHistory();
                }
            };

            // Button event listeners
            document.getElementById('btn-buy')?.addEventListener('click', () => addTrade('buy'));
            document.getElementById('btn-sell')?.addEventListener('click', () => addTrade('sell'));

            // Initial render
            renderTradeHistory();

            // ==============================
            // Line Drawing Feature
            // ==============================
            const LINES_KEY = 'insight_chart_lines';
            let isDrawingMode = false;
            let drawingStartPoint = null;
            let drawnLines = [];

            const stockChart = document.getElementById('stock-chart');
            const overlayCanvas = document.getElementById('drawing-overlay');
            const overlayCtx = overlayCanvas.getContext('2d');
            const btnDrawLine = document.getElementById('btn-draw-line');
            const btnClearLines = document.getElementById('btn-clear-lines');

            // Load saved lines from localStorage
            function loadLines() {
                const data = localStorage.getItem(LINES_KEY);
                if (data) {
                    const allLines = JSON.parse(data);
                    drawnLines = allLines[ticker] || [];
                }
            }

            // Save lines to localStorage
            function saveLines() {
                const data = localStorage.getItem(LINES_KEY);
                const allLines = data ? JSON.parse(data) : {};
                allLines[ticker] = drawnLines;
                localStorage.setItem(LINES_KEY, JSON.stringify(allLines));
            }

            // Resize overlay canvas to match stock chart
            function resizeOverlay() {
                const rect = stockChart.getBoundingClientRect();
                overlayCanvas.width = rect.width;
                overlayCanvas.height = rect.height;
                redrawLines();
            }

            // Redraw all lines
            function redrawLines() {
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

                drawnLines.forEach(line => {
                    overlayCtx.beginPath();
                    overlayCtx.moveTo(line.x1, line.y1);
                    overlayCtx.lineTo(line.x2, line.y2);
                    overlayCtx.strokeStyle = line.color || '#f59e0b';
                    overlayCtx.lineWidth = 2;
                    overlayCtx.setLineDash([]);
                    overlayCtx.stroke();

                    // Draw endpoints
                    [{ x: line.x1, y: line.y1 }, { x: line.x2, y: line.y2 }].forEach(pt => {
                        overlayCtx.beginPath();
                        overlayCtx.arc(pt.x, pt.y, 4, 0, Math.PI * 2);
                        overlayCtx.fillStyle = line.color || '#f59e0b';
                        overlayCtx.fill();
                    });
                });

                // Draw pending point if exists
                if (drawingStartPoint) {
                    overlayCtx.beginPath();
                    overlayCtx.arc(drawingStartPoint.x, drawingStartPoint.y, 5, 0, Math.PI * 2);
                    overlayCtx.fillStyle = '#22c55e';
                    overlayCtx.fill();
                    overlayCtx.strokeStyle = '#22c55e';
                    overlayCtx.lineWidth = 2;
                    overlayCtx.stroke();
                }
            }

            // Toggle drawing mode
            btnDrawLine.addEventListener('click', () => {
                isDrawingMode = !isDrawingMode;
                btnDrawLine.classList.toggle('active', isDrawingMode);
                overlayCanvas.style.pointerEvents = isDrawingMode ? 'auto' : 'none';
                stockChart.style.cursor = isDrawingMode ? 'crosshair' : 'default';

                if (!isDrawingMode) {
                    drawingStartPoint = null;
                    redrawLines();
                }
            });

            // Clear all lines
            btnClearLines.addEventListener('click', () => {
                if (drawnLines.length === 0) return;
                if (!confirm('ëª¨ë“  ì§ì„ ì„ ì‚­ì œí• ê¹Œìš”?')) return;
                drawnLines = [];
                drawingStartPoint = null;
                saveLines();
                redrawLines();
            });

            // Handle click on overlay (drawing)
            overlayCanvas.addEventListener('click', (e) => {
                if (!isDrawingMode) return;

                const rect = overlayCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (!drawingStartPoint) {
                    // First click - set start point
                    drawingStartPoint = { x, y };
                    redrawLines();
                } else {
                    // Second click - draw line and continue from this point
                    drawnLines.push({
                        x1: drawingStartPoint.x,
                        y1: drawingStartPoint.y,
                        x2: x,
                        y2: y,
                        color: '#f59e0b',
                        timestamp: Date.now()
                    });
                    // Continue drawing from this point (ì—°ì† ì§ì„ )
                    drawingStartPoint = { x, y };
                    saveLines();
                    redrawLines();
                }
            });

            // Handle mouse move for preview line
            overlayCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawingMode || !drawingStartPoint) return;

                const rect = overlayCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                redrawLines();

                // Draw preview line
                overlayCtx.beginPath();
                overlayCtx.moveTo(drawingStartPoint.x, drawingStartPoint.y);
                overlayCtx.lineTo(x, y);
                overlayCtx.strokeStyle = 'rgba(245, 158, 11, 0.5)';
                overlayCtx.lineWidth = 2;
                overlayCtx.setLineDash([5, 5]);
                overlayCtx.stroke();
                overlayCtx.setLineDash([]);
            });

            // Cancel drawing with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && drawingStartPoint) {
                    drawingStartPoint = null;
                    redrawLines();
                }
            });

            // Initialize
            loadLines();
            resizeOverlay();
            window.addEventListener('resize', resizeOverlay);

            // Redraw on chart update
            const observer = new ResizeObserver(resizeOverlay);
            observer.observe(stockChart);
        });
    </script>
</body>

</html>